#include "distance_sensor.h"

#include <adc.h>

DistanceSensor distance_sensor;

DistanceSensor::DistanceSensor()
{
  front_ir_led = 0;
}

DistanceSensor::~DistanceSensor()
{

}

int DistanceSensor::init()
{
  state = 0;
  front_ir_led = 0;

  for (unsigned int i = 0; i < DISTANCE_SENSOR_COUNT; i++)
    adc_res_on[i] = 0;

  for (unsigned int i = 0; i < DISTANCE_SENSOR_COUNT; i++)
    adc_res_off[i] = 0;

  result.left = DISTANCE_MAX;
  result.front = DISTANCE_MAX;
  result.right = DISTANCE_MAX;


  return 0;
}

void DistanceSensor::read()
{
  switch (state)
  {
    case 0:
    {

      adc_res_off[DISTANCE_FRONT] = adc_read(ADC_FRONT);
      adc_res_off[DISTANCE_LEFT]  = adc_read(ADC_LEFT);
      adc_res_off[DISTANCE_RIGHT] = adc_read(ADC_RIGHT);

      front_ir_led = 1;

      state = 1;
    }
    break;

    case 1:
    {
      adc_res_on[DISTANCE_FRONT]  = adc_read(ADC_FRONT);
      adc_res_on[DISTANCE_LEFT]   = adc_read(ADC_LEFT);
      adc_res_on[DISTANCE_RIGHT]  = adc_read(ADC_RIGHT);

      front_ir_led = 0;

      filter(&result.front, DISTANCE_FRONT);
      filter(&result.left, DISTANCE_LEFT);
      filter(&result.right, DISTANCE_RIGHT);

      state = 0;
    }
    break;
  }
}

void DistanceSensor::filter(int *res_prev, unsigned int sensor_id)
{
  int dif = adc_res_off[sensor_id] - adc_res_on[sensor_id];
  if (dif < 0)
    dif = 0;

  int k = 3;
  *res_prev = (k* (*res_prev) + (DISTANCE_MAX*(4096 - dif))/4096)/(1+k);
}
